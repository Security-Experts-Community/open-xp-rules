{"action": "start", "body": "{ \"Event\": { \"xmlns\": \"http://schemas.microsoft.com/win/2004/08/events/event\", \"System\": { \"Provider\": { \"Name\": \"Microsoft-Windows-Sysmon\", \"Guid\": \"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}\" }, \"EventID\": \"1\", \"Version\": \"5\", \"Level\": \"4\", \"Task\": \"1\", \"Opcode\": \"0\", \"Keywords\": \"0x8000000000000000\", \"TimeCreated\": { \"SystemTime\": \"2021-08-16T13:16:24.2433848Z\" }, \"EventRecordID\": \"10277287\", \"Correlation\": null, \"Execution\": { \"ProcessID\": \"3548\", \"ThreadID\": \"4948\" }, \"Channel\": \"Microsoft-Windows-Sysmon/Operational\", \"Computer\": \"Test_w10x64-130.testlab.org\", \"Security\": { \"UserID\": \"S-1-5-18\" } }, \"EventData\": { \"Data\": [ { \"Name\": \"RuleName\" }, { \"text\": \"2021-08-16 13:16:24.239\", \"Name\": \"UtcTime\" }, { \"text\": \"{63310a87-6528-611a-0000-00106bb3f401}\", \"Name\": \"ProcessGuid\" }, { \"text\": \"8668\", \"Name\": \"ProcessId\" }, { \"text\": \"C:\\\\Windows\\\\System32\\\\schtasks.exe\", \"Name\": \"Image\" }, { \"text\": \"10.0.19041.906 (WinBuild.160101.0800)\", \"Name\": \"FileVersion\" }, { \"text\": \"Task Scheduler Configuration Tool\", \"Name\": \"Description\" }, { \"text\": \"Microsoft® Windows® Operating System\", \"Name\": \"Product\" }, { \"text\": \"Microsoft Corporation\", \"Name\": \"Company\" }, { \"text\": \"schtasks.exe\", \"Name\": \"OriginalFileName\" }, { \"text\": \"\\\"C:\\\\WINDOWS\\\\system32\\\\schtasks.exe\\\" -create -tn test /sc Onstart\", \"Name\": \"CommandLine\" }, { \"text\": \"C:\\\\Users\\\\username\\\\Desktop\\\\\", \"Name\": \"CurrentDirectory\" }, { \"text\": \"TESTLAB\\\\username\", \"Name\": \"User\" }, { \"text\": \"{63310a87-5f74-611a-0000-00204f8fcc01}\", \"Name\": \"LogonGuid\" }, { \"text\": \"0x1cc8f4f\", \"Name\": \"LogonId\" }, { \"text\": \"2\", \"Name\": \"TerminalSessionId\" }, { \"text\": \"High\", \"Name\": \"IntegrityLevel\" }, { \"text\": \"MD5=796B784E98008854C27F4B18D287BA30,SHA256=356280CCA63CA5E887FDBE5CB4105A53341FBAC9219EFC51621DF9BA8EE9838B\", \"Name\": \"Hashes\" }, { \"text\": \"{63310a87-64dd-611a-0000-0010b515f401}\", \"Name\": \"ParentProcessGuid\" }, { \"text\": \"7148\", \"Name\": \"ParentProcessId\" }, { \"text\": \"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\", \"Name\": \"ParentImage\" }, { \"text\": \"\\\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\\" \", \"Name\": \"ParentCommandLine\" } ] }, \"RenderingInfo\": { \"Culture\": \"en-US\", \"Message\": \"Process Create:\\r\\nRuleName: \\r\\nUtcTime: 2021-08-16 13:16:24.239\\r\\nProcessGuid: {63310a87-6528-611a-0000-00106bb3f401}\\r\\nProcessId: 8668\\r\\nImage: C:\\\\Windows\\\\System32\\\\schtasks.exe\\r\\nFileVersion: 10.0.19041.906 (WinBuild.160101.0800)\\r\\nDescription: Task Scheduler Configuration Tool\\r\\nProduct: Microsoft® Windows® Operating System\\r\\nCompany: Microsoft Corporation\\r\\nOriginalFileName: schtasks.exe\\r\\nCommandLine: \\\"C:\\\\WINDOWS\\\\system32\\\\schtasks.exe\\\" -create -tn test /sc Onstart\\r\\nCurrentDirectory: C:\\\\Users\\\\username\\\\Desktop\\\\\\r\\nUser: TESTLAB\\\\username\\r\\nLogonGuid: {63310a87-5f74-611a-0000-00204f8fcc01}\\r\\nLogonId: 0x1CC8F4F\\r\\nTerminalSessionId: 2\\r\\nIntegrityLevel: High\\r\\nHashes: MD5=796B784E98008854C27F4B18D287BA30,SHA256=356280CCA63CA5E887FDBE5CB4105A53341FBAC9219EFC51621DF9BA8EE9838B\\r\\nParentProcessGuid: {63310a87-64dd-611a-0000-0010b515f401}\\r\\nParentProcessId: 7148\\r\\nParentImage: C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\r\\nParentCommandLine: \\\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\\" \", \"Level\": \"Information\", \"Task\": \"Process Create (rule: ProcessCreate)\", \"Opcode\": \"Info\", \"Channel\": null, \"Provider\": null, \"Keywords\": null } } }", "category.generic": "Process", "category.high": "Availability Management", "category.low": "Control", "datafield6": "63310a87-5f74-611a-0000-00204f8fcc01", "event_src.category": "Other", "event_src.fqdn": "test_w10x64-130.testlab.org", "event_src.host": "test_w10x64-130.testlab.org", "event_src.hostname": "test_w10x64-130", "event_src.subsys": "Microsoft-Windows-Sysmon/Operational", "event_src.title": "sysmon", "event_src.vendor": "microsoft", "generator.type": "logcollector", "generator.version": "N26.0.2936", "id": "PT_Microsoft_Windows_eventlog_Sysmon_1_Process_creation", "importance": "info", "input_id": "00000000-0000-0000-0000-000000000000", "mime": "application/x-pt-eventlog", "msgid": "1", "normalized": true, "object": "process", "object.account.domain": "testlab", "object.account.id": "synthetic:username@testlab", "object.account.name": "username", "object.account.privileges": "High", "object.account.session_id": "30183247", "object.process.cmdline": "\"C:\\WINDOWS\\system32\\schtasks.exe\" -create -tn test /sc Onstart", "object.process.cwd": "C:\\Users\\username\\Desktop\\", "object.process.fullpath": "c:\\windows\\system32\\schtasks.exe", "object.process.guid": "63310a87-6528-611a-0000-00106bb3f401", "object.process.hash.md5": "796B784E98008854C27F4B18D287BA30", "object.process.hash.sha256": "356280CCA63CA5E887FDBE5CB4105A53341FBAC9219EFC51621DF9BA8EE9838B", "object.process.id": "8668", "object.process.meta": "Description:Task Scheduler Configuration Tool | Product:Microsoft® Windows® Operating System | Company:Microsoft Corporation", "object.process.name": "schtasks.exe", "object.process.original_name": "schtasks.exe", "object.process.parent.cmdline": "\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\"", "object.process.parent.fullpath": "c:\\windows\\system32\\windowspowershell\\v1.0\\powershell.exe", "object.process.parent.guid": "63310a87-64dd-611a-0000-0010b515f401", "object.process.parent.id": "7148", "object.process.parent.name": "powershell.exe", "object.process.parent.path": "c:\\windows\\system32\\windowspowershell\\v1.0\\", "object.process.path": "c:\\windows\\system32\\", "object.process.version": "10.0.19041.906 (WinBuild.160101.0800)", "recv_ipv4": "127.0.0.1", "recv_time": "2021-08-16T16:37:30Z", "status": "success", "subject": "account", "subject.account.domain": "testlab", "subject.account.id": "synthetic:username@testlab", "subject.account.name": "username", "subject.account.privileges": "High", "subject.account.session_id": "30183247", "task_id": "00000000-0000-0000-0000-000000000000", "taxonomy_version": "26.0.215-release-26.0", "time": "2021-08-16T13:16:24.239Z", "type": "raw", "uuid": "7fb070f5-9025-47dd-a392-21c8aecd2303"}

# Тут будет твой тест. В секции expect укажи сколько и каких корреляционных событий ты ожидаешь
expect 1 								{"action": "create", "alert.context": "create the task: test|regex_match: schtasks.exe\" -create", "alert.key": "\"c:\\windows\\system32\\schtasks.exe\" -create -tn test /sc onstart", "category.generic": "Attack", "category.high": "Execution", "category.low": "Scheduled Task", "correlation_name": "Schtasks_Commandline", "correlation_type": "event", "datafield6": "63310a87-5f74-611a-0000-00204f8fcc01", "event_src.category": "Other", "event_src.fqdn": "test_w10x64-130.testlab.org", "event_src.host": "test_w10x64-130.testlab.org", "event_src.hostname": "test_w10x64-130", "event_src.subsys": "Microsoft-Windows-Sysmon/Operational", "event_src.title": "sysmon", "event_src.vendor": "microsoft", "importance": "high", "incident.aggregation.key": "Schtasks_Commandline|test_w10x64-130.testlab.org|synthetic:username@testlab|username|create", "incident.aggregation.timeout": 7200, "incident.category": "Undefined", "incident.severity": "high", "object": "process", "object.account.domain": "testlab", "object.account.id": "synthetic:username@testlab", "object.account.name": "username", "object.account.session_id": "30183247", "object.name": "test", "object.process.cmdline": "\"C:\\WINDOWS\\system32\\schtasks.exe\" -create -tn test /sc Onstart", "object.process.cwd": "C:\\Users\\username\\Desktop\\", "object.process.fullpath": "c:\\windows\\system32\\schtasks.exe", "object.process.guid": "63310a87-6528-611a-0000-00106bb3f401", "object.process.id": "8668", "object.process.meta": "Description:Task Scheduler Configuration Tool | Product:Microsoft® Windows® Operating System | Company:Microsoft Corporation", "object.process.name": "schtasks.exe", "object.process.original_name": "schtasks.exe", "object.process.parent.cmdline": "\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\"", "object.process.parent.fullpath": "c:\\windows\\system32\\windowspowershell\\v1.0\\powershell.exe", "object.process.parent.guid": "63310a87-64dd-611a-0000-0010b515f401", "object.process.parent.id": "7148", "object.process.parent.name": "powershell.exe", "object.process.parent.path": "c:\\windows\\system32\\windowspowershell\\v1.0\\", "object.process.path": "c:\\windows\\system32\\", "object.process.version": "10.0.19041.906 (WinBuild.160101.0800)", "status": "success", "subject": "account", "subject.account.domain": "testlab", "subject.account.id": "synthetic:username@testlab", "subject.account.name": "username", "subject.account.privileges": "High", "subject.account.session_id": "30183247"}
