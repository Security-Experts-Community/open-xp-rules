{"action": "execute", "body": "{ \"Event\": { \"xmlns\": \"http://schemas.microsoft.com/win/2004/08/events/event\", \"System\": { \"Provider\": { \"Name\": \"Microsoft-Windows-PowerShell\", \"Guid\": \"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" }, \"EventID\": \"4103\", \"Version\": \"1\", \"Level\": \"4\", \"Task\": \"106\", \"Opcode\": \"20\", \"Keywords\": \"0x0\", \"TimeCreated\": { \"SystemTime\": \"2021-08-16T14:30:58.9480233Z\" }, \"EventRecordID\": \"661880\", \"Correlation\": { \"ActivityID\": \"{a5f1f89b-9179-0002-50e2-f2a57991d701}\" }, \"Execution\": { \"ProcessID\": \"7148\", \"ThreadID\": \"5328\" }, \"Channel\": \"Microsoft-Windows-PowerShell/Operational\", \"Computer\": \"Test_w10x64-130.testlab.org\", \"Security\": { \"UserID\": \"S-1-5-21-1129291328-2819992169-918366777-1113\" } }, \"EventData\": { \"Data\": [ { \"text\": \" Severity = Informational\\r\\n Host Name = ConsoleHost\\r\\n Host Version = 5.1.19041.1151\\r\\n Host ID = 5e42d873-69cb-4e36-be87-477b62fbd6d7\\r\\n Host Application = C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\r\\n Engine Version = 5.1.19041.1151\\r\\n Runspace ID = 42cacf1f-2d8b-4a39-a17a-273e3f3df292\\r\\n Pipeline ID = 86\\r\\n Command Name = Invoke-Expression\\r\\n Command Type = Cmdlet\\r\\n Script Name = \\r\\n Command Path = \\r\\n Sequence Number = 180\\r\\n User = TESTLAB\\\\username\\r\\n Connected User = \\r\\n Shell ID = Microsoft.PowerShell\\r\\n\", \"Name\": \"ContextInfo\" }, { \"Name\": \"UserData\" }, { \"text\": \"CommandInvocation(Invoke-Expression): \\\"Invoke-Expression\\\"\\r\\nParameterBinding(Invoke-Expression): name=\\\"Command\\\"; value=\\\"Stop-ScheduledTask -taskname test\\\"\\r\\n\", \"Name\": \"Payload\" } ] }, \"RenderingInfo\": { \"Culture\": \"en-US\", \"Message\": \"CommandInvocation(Invoke-Expression): \\\"Invoke-Expression\\\"\\r\\nParameterBinding(Invoke-Expression): name=\\\"Command\\\"; value=\\\"Stop-ScheduledTask -taskname test\\\"\\r\\n\\r\\n\\r\\nContext:\\r\\n Severity = Informational\\r\\n Host Name = ConsoleHost\\r\\n Host Version = 5.1.19041.1151\\r\\n Host ID = 5e42d873-69cb-4e36-be87-477b62fbd6d7\\r\\n Host Application = C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\r\\n Engine Version = 5.1.19041.1151\\r\\n Runspace ID = 42cacf1f-2d8b-4a39-a17a-273e3f3df292\\r\\n Pipeline ID = 86\\r\\n Command Name = Invoke-Expression\\r\\n Command Type = Cmdlet\\r\\n Script Name = \\r\\n Command Path = \\r\\n Sequence Number = 180\\r\\n User = TESTLAB\\\\username\\r\\n Connected User = \\r\\n Shell ID = Microsoft.PowerShell\\r\\n\\r\\n\\r\\nUser Data:\\r\\n\\r\\n\", \"Level\": \"Information\", \"Task\": \"Executing Pipeline\", \"Opcode\": \"To be used when operation is just executing a method\", \"Channel\": \"Microsoft-Windows-PowerShell/Operational\", \"Provider\": null, \"Keywords\": null } } }", "category.generic": "Command", "category.high": "System Management", "category.low": "Manipulation", "chain_id": "86", "datafield8": "5.1.19041.1151", "event_src.category": "Operating system", "event_src.fqdn": "test_w10x64-130.testlab.org", "event_src.host": "test_w10x64-130.testlab.org", "event_src.hostname": "test_w10x64-130", "event_src.subsys": "Microsoft-Windows-PowerShell/Operational", "event_src.title": "windows", "event_src.vendor": "microsoft", "generator.type": "logcollector", "generator.version": "N26.0.2936", "id": "PT_Microsoft_Windows_eventlog_Common_PowerShell_4103_pipeline_executed", "importance": "info", "input_id": "00000000-0000-0000-0000-000000000000", "mime": "application/x-pt-eventlog", "msgid": "4103", "normalized": true, "object": "command", "object.account.domain": "testlab", "object.account.id": "S-1-5-21-1129291328-2819992169-918366777-1113", "object.account.name": "username", "object.process.cmdline": "\"Invoke-Expression\" -Command \"Stop-ScheduledTask -taskname test\"", "object.process.name": "Invoke-Expression", "object.process.parent.cmdline": "c:\\windows\\system32\\windowspowershell\\v1.0\\powershell.exe", "object.process.parent.guid": "5e42d873-69cb-4e36-be87-477b62fbd6d7", "object.process.parent.id": "7148", "object.value": "CommandInvocation(Invoke-Expression): \"Invoke-Expression\"\r\nParameterBinding(Invoke-Expression): name=\"Command\"; value=\"Stop-ScheduledTask -taskname test\"", "recv_ipv4": "127.0.0.1", "recv_time": "2021-08-16T17:32:14Z", "status": "success", "subject": "account", "subject.account.domain": "testlab", "subject.account.id": "S-1-5-21-1129291328-2819992169-918366777-1113", "subject.account.name": "username", "task_id": "00000000-0000-0000-0000-000000000000", "taxonomy_version": "26.0.215-release-26.0", "time": "2021-08-16T14:30:58.948Z", "type": "raw", "uuid": "107bcd70-6173-48a4-969b-05bce36a8384"}

# Тут будет твой тест. В секции expect укажи сколько и каких корреляционных событий ты ожидаешь
expect 1 								{"action": "stop", "alert.context": "stop the task: test|regex_match: stop-scheduledtask", "alert.key": "\"invoke-expression\" -command \"stop-scheduledtask -taskname test\"", "category.generic": "Attack", "category.high": "Execution", "category.low": "Scheduled Task", "chain_id": "86", "correlation_name": "Schtasks_Commandline", "correlation_type": "event", "datafield8": "5.1.19041.1151", "event_src.category": "Operating system", "event_src.fqdn": "test_w10x64-130.testlab.org", "event_src.host": "test_w10x64-130.testlab.org", "event_src.hostname": "test_w10x64-130", "event_src.subsys": "Microsoft-Windows-PowerShell/Operational", "event_src.title": "windows", "event_src.vendor": "microsoft", "importance": "medium", "incident.aggregation.key": "Schtasks_Commandline|test_w10x64-130.testlab.org|S-1-5-21-1129291328-2819992169-918366777-1113|username|stop", "incident.aggregation.timeout": 7200, "incident.category": "Undefined", "incident.severity": "high", "object": "command", "object.account.domain": "testlab", "object.account.id": "S-1-5-21-1129291328-2819992169-918366777-1113", "object.account.name": "username", "object.name": "test", "object.process.cmdline": "\"Invoke-Expression\" -Command \"Stop-ScheduledTask -taskname test\"", "object.process.name": "Invoke-Expression", "object.process.parent.cmdline": "c:\\windows\\system32\\windowspowershell\\v1.0\\powershell.exe", "object.process.parent.guid": "5e42d873-69cb-4e36-be87-477b62fbd6d7", "object.process.parent.id": "7148", "object.value": "CommandInvocation(Invoke-Expression): \"Invoke-Expression\"\r\nParameterBinding(Invoke-Expression): name=\"Command\"; value=\"Stop-ScheduledTask -taskname test\"", "status": "success", "subject": "account", "subject.account.domain": "testlab", "subject.account.id": "S-1-5-21-1129291328-2819992169-918366777-1113", "subject.account.name": "username"}