{"action": "modify", "body": "{\"Event\":{\"xmlns\":\"http://schemas.microsoft.com/win/2004/08/events/event\",\"System\":{\"Provider\":{\"Name\":\"Microsoft-Windows-Sysmon\",\"Guid\":\"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}\"},\"EventID\":\"13\",\"Version\":\"2\",\"Level\":\"4\",\"Task\":\"13\",\"Opcode\":\"0\",\"Keywords\":\"0x8000000000000000\",\"TimeCreated\":{\"SystemTime\":\"2023-06-12T18:38:16.4543484Z\"},\"EventRecordID\":\"48191421\",\"Correlation\":\"\",\"Execution\":{\"ProcessID\":\"3636\",\"ThreadID\":\"4616\"},\"Channel\":\"Microsoft-Windows-Sysmon/Operational\",\"Computer\":\"win10-work.stand2008.local\",\"Security\":{\"UserID\":\"S-1-5-18\"}},\"EventData\":{\"Data\":[{\"Name\":\"RuleName\",\"text\":\"T1547_001,Create Persistance: Registry Run Keys\"},{\"Name\":\"EventType\",\"text\":\"SetValue\"},{\"Name\":\"UtcTime\",\"text\":\"2023-06-12 18:38:16.439\"},{\"Name\":\"ProcessGuid\",\"text\":\"{2b856446-6613-6487-dc09-00000000c100}\"},{\"Name\":\"ProcessId\",\"text\":\"11532\"},{\"Name\":\"Image\",\"text\":\"E:\\\\work\\\\projects\\\\InvisiblePersistence\\\\InvisibleKeys\\\\x64\\\\Release\\\\InvisibleRegKeys.exe\"},{\"Name\":\"TargetObject\",\"text\":\"HKU\\\\S-1-5-21-3800063338-4262557262-2801230003-500\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\"},{\"Name\":\"Details\",\"text\":\"\\\"C:\\\\WINDOWS\\\\system32\\\\mshta.exe\\\" \\\"javascript:z1kHl=\\\"SiBZQ\\\";I6M2=new ActiveXObject(\\\"WScript.Shell\\\");qs0Nn=\\\"2BEh4hFR\\\";lEgt9=I6M2.RegRead(\\\"HKCU\\\\\\\\software\\\\\\\\WUV\\\\\\\\Tethering\\\");dpP1iXav=\\\"hX9bkPRH\\\";eval(lEgt9);nro9M=\\\"ioQzi30v\\\";\\\"\"},{\"Name\":\"User\",\"text\":\"STAND2008\\\\Администратор\"}]}}}", "category.generic": "Registry Object", "category.high": "System Management", "category.low": "Manipulation", "event_src.category": "Other", "event_src.fqdn": "win10-work.stand2008.local", "event_src.host": "win10-work.stand2008.local", "event_src.hostname": "win10-work", "event_src.rule": "T1547_001,Create Persistance: Registry Run Keys", "event_src.subsys": "Microsoft-Windows-Sysmon/Operational", "event_src.title": "sysmon", "event_src.vendor": "microsoft", "generator.type": "logcollector", "generator.version": "N26.0.2936", "id": "PT_Microsoft_Windows_eventlog_Sysmon_13_Registry_value_changed", "importance": "info", "input_id": "00000000-0000-0000-0000-000000000000", "mime": "application/x-pt-eventlog", "msgid": "13", "normalized": true, "object": "reg_object", "object.fullpath": "\\registry\\user\\s-1-5-21-3800063338-4262557262-2801230003-500\\software\\microsoft\\windows\\currentversion\\run\\", "object.new_value": "\"c:\\windows\\system32\\mshta.exe\" \"javascript:z1khl=\"sibzq\";i6m2=new activexobject(\"wscript.shell\");qs0nn=\"2beh4hfr\";legt9=i6m2.regread(\"hkcu\\\\software\\\\wuv\\\\tethering\");dpp1ixav=\"hx9bkprh\";eval(legt9);nro9m=\"ioqzi30v\";\"", "object.path": "\\registry\\user\\s-1-5-21-3800063338-4262557262-2801230003-500\\software\\microsoft\\windows\\currentversion\\run\\", "object.property": "value", "recv_ipv4": "127.0.0.1", "recv_time": "2023-06-12T19:20:52.205Z", "status": "success", "subject.account.domain": "stand2008", "subject.account.id": "synthetic:администратор@stand2008", "subject.account.name": "администратор", "subject.process.fullpath": "e:\\work\\projects\\invisiblepersistence\\invisiblekeys\\x64\\release\\invisibleregkeys.exe", "subject.process.guid": "2b856446-6613-6487-dc09-00000000c100", "subject.process.id": "11532", "subject.process.name": "invisibleregkeys.exe", "subject.process.path": "e:\\work\\projects\\invisiblepersistence\\invisiblekeys\\x64\\release\\", "tag": "some_tag", "task_id": "00000000-0000-0000-0000-000000000000", "taxonomy_version": "26.0.215-release-26.0", "time": "2023-06-12T18:38:16.439Z", "type": "raw", "uuid": "355b22a5-48d0-40ab-aaa3-0d5aae285250"}
{"action": "modify", "body": "{\"Event\":{\"xmlns\":\"http://schemas.microsoft.com/win/2004/08/events/event\",\"System\":{\"Provider\":{\"Name\":\"Microsoft-Windows-Sysmon\",\"Guid\":\"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}\"},\"EventID\":\"13\",\"Version\":\"2\",\"Level\":\"4\",\"Task\":\"13\",\"Opcode\":\"0\",\"Keywords\":\"0x8000000000000000\",\"TimeCreated\":{\"SystemTime\":\"2023-06-12T18:30:05.5025934Z\"},\"EventRecordID\":\"48184711\",\"Correlation\":\"\",\"Execution\":{\"ProcessID\":\"3636\",\"ThreadID\":\"4616\"},\"Channel\":\"Microsoft-Windows-Sysmon/Operational\",\"Computer\":\"win10-work.stand2008.local\",\"Security\":{\"UserID\":\"S-1-5-18\"}},\"EventData\":{\"Data\":[{\"Name\":\"RuleName\",\"text\":\"T1547_001,Create Persistance: Registry Run Keys\"},{\"Name\":\"EventType\",\"text\":\"SetValue\"},{\"Name\":\"UtcTime\",\"text\":\"2023-06-12 18:30:05.499\"},{\"Name\":\"ProcessGuid\",\"text\":\"{2b856446-642d-6487-a509-00000000c100}\"},{\"Name\":\"ProcessId\",\"text\":\"12488\"},{\"Name\":\"Image\",\"text\":\"C:\\\\Windows\\\\system32\\\\reg.exe\"},{\"Name\":\"TargetObject\",\"text\":\"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunonceEx\\\\Line1\"},{\"Name\":\"Details\",\"text\":\"||c:\\\\windows\\\\system32\\\\cmd.exe\"},{\"Name\":\"User\",\"text\":\"STAND2008\\\\Администратор\"}]}}}", "category.generic": "Registry Object", "category.high": "System Management", "category.low": "Manipulation", "event_src.category": "Other", "event_src.fqdn": "win10-work.stand2008.local", "event_src.host": "win10-work.stand2008.local", "event_src.hostname": "win10-work", "event_src.rule": "T1547_001,Create Persistance: Registry Run Keys", "event_src.subsys": "Microsoft-Windows-Sysmon/Operational", "event_src.title": "sysmon", "event_src.vendor": "microsoft", "generator.type": "logcollector", "generator.version": "N26.0.2936", "id": "PT_Microsoft_Windows_eventlog_Sysmon_13_Registry_value_changed", "importance": "info", "input_id": "00000000-0000-0000-0000-000000000000", "mime": "application/x-pt-eventlog", "msgid": "13", "normalized": true, "object": "reg_object", "object.fullpath": "\\registry\\machine\\software\\microsoft\\windows nt\\currentversion\\terminal server\\install\\software\\microsoft\\windows\\currentversion\\runonceex\\line1", "object.name": "line1", "object.new_value": "||c:\\windows\\system32\\cmd.exe", "object.path": "\\registry\\machine\\software\\microsoft\\windows nt\\currentversion\\terminal server\\install\\software\\microsoft\\windows\\currentversion\\runonceex\\", "object.property": "value", "recv_ipv4": "127.0.0.1", "recv_time": "2023-06-12T19:20:52.206Z", "status": "success", "subject.account.domain": "stand2008", "subject.account.id": "synthetic:администратор@stand2008", "subject.account.name": "администратор", "subject.process.fullpath": "c:\\windows\\system32\\reg.exe", "subject.process.guid": "2b856446-642d-6487-a509-00000000c100", "subject.process.id": "12488", "subject.process.name": "reg.exe", "subject.process.path": "c:\\windows\\system32\\", "tag": "some_tag", "task_id": "00000000-0000-0000-0000-000000000000", "taxonomy_version": "26.0.215-release-26.0", "time": "2023-06-12T18:30:05.499Z", "type": "raw", "uuid": "09245b1b-23b0-4de5-bcb1-2b7623fedc21"}

# Тут будет твой тест. В секции expect укажи сколько и каких корреляционных событий ты ожидаешь
expect 1 {"action": "modify", "category.generic": "Attack", "category.high": "Persistence", "category.low": "Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder", "correlation_name": "Create_persist_via_Hidden_Run_key_value", "correlation_type": "incident", "event_src.category": "Other", "event_src.fqdn": "win10-work.stand2008.local", "event_src.host": "win10-work.stand2008.local", "event_src.hostname": "win10-work", "event_src.rule": "T1547_001,Create Persistance: Registry Run Keys", "event_src.subsys": "Microsoft-Windows-Sysmon/Operational", "event_src.title": "sysmon", "event_src.vendor": "microsoft", "importance": "medium", "incident.aggregation.key": "Create_persist_via_Hidden_Run_key_value|win10-work.stand2008.local|invisibleregkeys.exe", "incident.aggregation.timeout": 7200, "incident.category": "Undefined", "incident.severity": "medium", "object": "reg_object", "object.fullpath": "\\registry\\user\\s-1-5-21-3800063338-4262557262-2801230003-500\\software\\microsoft\\windows\\currentversion\\run\\", "object.new_value": "\"c:\\windows\\system32\\mshta.exe\" \"javascript:z1khl=\"sibzq\";i6m2=new activexobject(\"wscript.shell\");qs0nn=\"2beh4hfr\";legt9=i6m2.regread(\"hkcu\\\\software\\\\wuv\\\\tethering\");dpp1ixav=\"hx9bkprh\";eval(legt9);nro9m=\"ioqzi30v\";\"", "object.path": "\\registry\\user\\s-1-5-21-3800063338-4262557262-2801230003-500\\software\\microsoft\\windows\\currentversion\\run\\", "object.property": "value", "status": "success", "subject": "account", "subject.account.domain": "stand2008", "subject.account.id": "synthetic:администратор@stand2008", "subject.account.name": "администратор", "subject.process.fullpath": "e:\\work\\projects\\invisiblepersistence\\invisiblekeys\\x64\\release\\invisibleregkeys.exe", "subject.process.guid": "2b856446-6613-6487-dc09-00000000c100", "subject.process.id": "11532", "subject.process.name": "invisibleregkeys.exe", "subject.process.path": "e:\\work\\projects\\invisiblepersistence\\invisiblekeys\\x64\\release\\"}
