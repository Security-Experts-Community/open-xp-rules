EVENTLOG = 'EventID="4742"'
COND = lower($Channel)=="security" and $Provider["Name"]=="Microsoft-Windows-Security-Auditing"

subject = "account"
action = "modify"
object = "account"
status = "success"

subject.account.id = $Data["SubjectUserSid"]
subject.account.name = lower($Data["SubjectUserName"])
subject.account.domain = lower($Data["SubjectDomainName"])
subject.account.session_id = maybe_number16($Data["SubjectLogonId"])

object.account.name = lower($Data["TargetUserName"])
object.account.domain = lower($Data["TargetDomainName"])
object.account.id = $Data["TargetSid"]

datafield2 = lower($Data["ServicePrincipalNames"])  

time = $TimeCreated["SystemTime"]
msgid = $EventID
importance = "low"

if $Data["PrivilegeList"] != "-" then
    reason = "_PrivilegeList:" + replace($Data["PrivilegeList"], "_", " ") + ";"
elif $Data["SamAccountName"] != "-" then
    reason = "_SamAccountName:" + replace($Data["SamAccountName"], "_", " ") + ";"
elif $Data["DisplayName"] != "-" then
    reason = "_DisplayName:" + replace($Data["DisplayName"], "_", " ") + ";"
elif $Data["UserPrincipalName"] != "-" then
    reason = "_UserPrincipalName:" + replace($Data["UserPrincipalName"], "_", " ") + ";"
elif $Data["HomeDirectory"] != "-" then
    reason = "_HomeDirectory:" + replace($Data["HomeDirectory"], "_", " ") + ";"
elif $Data["HomePath"] != "-" then
    reason = "_HomePath:" + replace($Data["HomePath"], "_", " ") + ";"
elif $Data["ScriptPath"] != "-" then
    reason = "_ScriptPath:" + replace($Data["ScriptPath"], "_", " ") + ";"
elif $Data["ProfilePath"] != "-" then
    reason = "_ProfilePath:" + replace($Data["ProfilePath"], "_", " ") + ";"
elif $Data["UserWorkstations"] != "-" then
    reason = "_UserWorkstations:" + replace($Data["UserWorkstations"], "_", " ") + ";"
elif $Data["PasswordLastSet"] != "-" then
    reason = "_PasswordLastSet:" + replace($Data["PasswordLastSet"], "_", " ") + ";"
elif $Data["AccountExpires"] != "-" then
    reason = "_AccountExpires:" + replace($Data["AccountExpires"], "_", " ") + ";"
elif $Data["PrimaryGroupId"] != "-" then
    reason = "_PrimaryGroupId:" + replace($Data["PrimaryGroupId"], "_", " ") + ";"
elif $Data["AllowedToDelegateTo"] != "-" then
    reason = "_AllowedToDelegateTo:" + replace($Data["AllowedToDelegateTo"], "_", " ") + ";"
elif $Data["OldUacValue"] != "-" then
    reason = "_OldUacValue:" + replace($Data["OldUacValue"], "_", " ") + ";"
elif $Data["NewUacValue"] != "-" then
    reason = "_NewUacValue:" + replace($Data["NewUacValue"], "_", " ") + ";"
elif $Data["UserAccountControl"] != "-" then
    reason = "_UserAccountControl:" + replace($Data["UserAccountControl"], "_", " ") + ";"
elif $Data["UserParameters"] != "-" then
    reason = "_UserParameters:" + replace($Data["UserParameters"], "_", " ") + ";"
elif $Data["SidHistory"] != "-" then
    reason = "_SidHistory:" + replace($Data["SidHistory"], "_", " ") + ";"
elif $Data["LogonHours"] != "-" then
    reason = "_LogonHours:" + replace($Data["LogonHours"], "_", " ") + ";"
elif $Data["DnsHostName"] != "-" then
    reason = "_DnsHostName:" + replace($Data["DnsHostName"], "_", " ") + ";"
elif $Data["ServicePrincipalNames"] != "-" then
    reason = "_ServicePrincipalNames:" + replace($Data["ServicePrincipalNames"], "_", " ") + ";"
endif

category.generic = "Account"
category.high = "Users And Rights Management"
category.low = "Manipulation"

event_src.vendor = "microsoft"
event_src.title = "windows"
event_src.subsys = $Channel
if find_substr($Computer, '.') != null then
    event_src.fqdn = lower($Computer)
    event_src.hostname = lower(substr($Computer, 0, find_substr($Computer, '.')))
else
    event_src.hostname = lower($Computer)
endif
event_src.category = "Directory service"

id = "PT_Microsoft_Windows_eventlog_4742_A_computer_account_was_changed"

